<style>
    #suiteLinksBox, #suiteBarButtons {
        display: contents !important
    }
    /*覆盖默认样式*/
    /*外边最大Table*/
    table {
        width: 100%;
    }

    #onetIDListForm {
        background: #fff;
        padding: 0 13px 0 16px;
        width: 80%;
        margin-left: 10%
    }
    /*包裹table的div*/
    #DeltaPlaceHolderMain .ms-webpart-zone {
        display: block;
        padding-left: 25px;
        padding-right: 25px;
    }
    /*% Complete添加%号的*/
    input[title="% Complete"] {
        width: 96% !important;
    }
    /*定义Option*/
    option {
        color: #00BCD4;
    }
    /*下划线*/
    .ms-formtable .ms-formlabel, .ms-formtable .ms-formbody {
        border-bottom: none;
    }
    /*hover变色*/
    .ms-formtable tr:hover {
        background-color: #fff;
    }
    /*label 蓝色显示*/
    .ms-formlabel h3.ms-standardheader {
        color: #337ab7;
        font-weight: 700;
    }
    /*组选择器,文本域*/
    .sp-peoplepicker-topLevel, .ms-rtefield, .sp-peoplepicker-editorInput {
        width: 100%;
        border-top: none;
        border-right: none;
        border-left: none;
        border-bottom-color: #d8d8d8;
    }
    /*Assigned To*/
    #onetIDListForm .sp-peoplepicker-topLevel {
        border: none;
        padding-left: 0;
        width: 100%;
    }

    input[type=password]:hover, input[type=text]:hover, input[type=file]:hover, textarea:hover, .sp-peoplepicker-topLevel:hover, .ms-inputBox:hover {
        border-color: #2196f3 !important;
    }
    /*输入框变长*/
    .ms-formtable input[size="11"] {
        width: 98%;
    }

    .ms-formtable input[size="1"] {
        max-width: 100% !important;
    }
    /*td添加内边距*/
    .ms-formtable td:not(.ms-dtinput) {
        padding: 4px 5px 4px 22px;
    }

    .ms-dtinput, .ms-dttimeinput {
        width: 100%;
    }
    /*table的表框线*/
    .ms-formtable {
        border: 1px solid #d8d8d8;
    }
    /*按钮下移*/
    #part1 > table[cellspacing="0"] {
        margin-top: 15px;
    }
    /*标题样式*/
    #tableHeader td {
        background-color: #337ab7;
        vertical-align: middle;
        text-align: center;
        height: 55px;
        color: #fff;
        font-size: 20px;
        font-weight: 700;
    }
    /*按钮样式*/
    #onetIDListForm input[type=button] {
        background-color: #337ab7 !important;
        font-weight: bold;
        font-size: 14px;
    }

    #onetIDListForm input[type=password], #onetIDListForm input[type=text], #onetIDListForm input[type=file], #onetIDListForm select {
        -webkit-box-shadow: none;
        -moz-box-shadow: none;
        box-shadow: none;
        border-top: none;
        border-right: none;
        border-left: none;
        outline: none;
        -webkit-border-radius: 0;
        -moz-border-radius: 0;
        border-radius: 0;
        border-bottom-color: #d8d8d8;
        width: 100%;
        -webkit-transition: all;
        -o-transition: all;
        transition: all;
        -webkit-transition-duration: 300ms;
        transition-duration: 300ms;
    }

    .fg-toggled {
        border-bottom-color: #2196f3 !important;
    }

    .form-group {
        margin-bottom: 0 !important
    }

    textarea {
        width: 100% !important;
        height: 100px
    }

    a[title="页面"], li[title="页面"] {
        display: contents !important;
    }
</style>
<script src="../../B2BRMAJS/jquery.SPServices-2014.02.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../B2BRMAJS/Product.js" type="text/javascript" charset="utf-8"></script>
<script src="../../B2BRMAJS/layer.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
    var user = getUser();
    var Department = getDepartment(user.LoginName);
    var id = getQueryString("ID");
    var data = getItem(id);
    function alertMessage(message) {
        layer.alert(message, {
            icon: 7,
            skin: 'layer-ext-moon'
        })
    }
    var HandlerTitle = data.Handler.Title;
    var CaseStatus = data.CaseStatus;
    $(function () {
        var length = $(".ms-RadioText").parent().parent().length;
        for (var i = 0; i < length; i++) {
            $(".ms-RadioText").parent().parent()[i].style.float = "left";
            if (i != 0) {
                $(".ms-RadioText").parent().parent()[i].style.marginLeft = "30px";
            }
        }
        lineChange();
        addTableHeader();
        $("#part1").children("table:last-child").css("display", "none");
        $("#CaseStatus").parent().parent().css("display", "none");
        $($("#gUid0").parent().parent()).css("display", "none")
        if (data.CaseStatus == "Draft") {
            if (data.Author.Title == user.Title) {
                $('input[title="Attachments"]').parent().html('<a href="javascript:;" onclick="AttachClick()">上传附件</a>');
                $("#part1").append('<div style="text-align:right;margin-top:10px"><input type="button" value="Save" style="margin-right:10px;text-transform:none" class="btn btn-primary btn-sm" onclick="Save()"></input><input  style="margin-right:10px;text-transform:none" type="button" value="Submit" class="btn btn-primary btn-sm" onclick="Submit()"></input><input  style="margin-right:10px;text-transform:none" type="button" value="Cancel" class="btn btn-primary btn-sm" onclick="Cancel()"></input></div>')
            } else {
                layer.msg('您无权修改此Case', {
                    time: 0,
                    btn: ['确认'],
                    yes: function (index) {
                        window.location.href = HomeHTML;
                    }
                });
            }
        } else {
            if (HandlerTitle == user.Title ||HanderList.indexOf(user.Title) >= 0) {
                // 拥有处理人权限
                $('#Attachments0').parent().parent().css("display", "none")
                $(".ms-propertysheet").css("display", "none")
                $("#part1").append('<div style="text-align:right;margin-top:10px"><input  style="margin-right:10px;text-transform:none" type="button" value="Submit" class="btn btn-primary btn-sm" onclick="Submit()"></input><input  style="margin-right:10px;text-transform:none" type="button" value="Cancel" class="btn btn-primary btn-sm" onclick="Cancel()"></input></div>')
            } else {
                var NotificationName = "";
                if (data.Notification_x0020_List.results) {
                    for (var i = 0; i < data.Notification_x0020_List.results.length; i++) {
                        NotificationName += data.Notification_x0020_List.results[i].Title + ";";
                    }
                }
                debugger;
                if (data.Author.Title == user.Title || ViewList.indexOf(user.Title) > 0 || NotificationName.indexOf(user.Title) >= 0) {
                    // 拥有查看权限
                    window.location.href = ViewUrl + id;
                } else {
                    layer.msg('您无权处理此Case', {
                        time: 0,
                        btn: ['确认'],
                        yes: function (index) {
                            window.location.href = HomeHTML
                        }
                    });
                }
            }
        }
    })
    function AttachClick() {
        SelectRibbonTab('Ribbon.ListForm.Edit', true);
        document.getElementById("Ribbon.ListForm.Edit.Actions.AttachFile-Large").click();
    }
    function lineChange() {
        $('body').on('focus', 'input', function () {
            $(this).addClass('fg-toggled');
        });
        $('body').on('blur', 'input', function () {
            $(this).removeClass('fg-toggled');
        });
    }
    function addTableHeader() {
        var tr = $("<tr id='tableHeader'><td colspan='4'>Complaint & Claim Reques</td></tr></div>");
        $('div[id^="WebPartWPQ"] .ms-formtable>tbody').prepend(tr);
    }
    function Save() {
        //此处跳转 更新数据
        layer.load(2);
        $($("#CaseStatus").parent().parent()[0].children[1]).find("input").val("Draft");
        if ($("input[value='保存']").length > 1) {
            $("input[value='保存']")[1].click()
        } else {
            $("input[value='保存']")[0].click()
        }
    }
    function Submit() {
        //此处跳转 更新数据 发送邮件
        layer.load(2);
        $($("#CaseStatus").parent().parent()[0].children[1]).find("input").val("Submit");
        if ($("input[value='保存']").length > 1) {
            $("input[value='保存']")[1].click()
        } else {
            $("input[value='保存']")[0].click()
        }
    }
    function Cancel() {
        layer.load(2);
        window.location.href = HomeHTML;
    }
</script>
<script>
    (function () {
        var percentCompleteFiledContext = {};
        percentCompleteFiledContext.Templates = {};
        percentCompleteFiledContext.Templates.OnPostRender = hiddenFiledOnPreRender;
        if (CaseStatus == "Draft") {
            percentCompleteFiledContext.Templates.Fields = {
                "Status": {
                    "EditForm": hiddenFiledTemplate,
                },
                "Amount": {
                    "EditForm": hiddenFiledTemplate,
                },
                "Title": {
                    "EditForm": readonlyFieldTemplate,
                }
            };
        } else {
            if (HandlerTitle == user.Title ||HanderList.indexOf(user.Title) >= 0) {
                percentCompleteFiledContext.Templates.Fields = {
                    "Title": {
                        "EditForm": readonlyFieldTemplate,
                    },
                    "Device": {
                        "EditForm": readonlyFieldTemplate,
                    },
                    "Supplier": {
                        "EditForm": readonlyFieldTemplate,
                    },
                    "count": {
                        "EditForm": readonlyFieldTemplate,
                    },
                    "unit": {
                        "EditForm": readonlyFieldTemplate,
                    },
                    "Issue_x0020_Description": {
                        "EditForm": readonlyFieldTemplate,
                    },
                    "Impact_x0020_Summary": {
                        "EditForm": readonlyFieldTemplate,
                    },
                    "SPRD_x0020_Request": {
                        "EditForm": readonlyFieldTemplate,
                    },
                    "Notification_x0020_List": {
                        "EditForm": readonlyFieldTemplate,
                    },
                    "Attachments0": {
                        "EditForm": readonlyFieldTemplate,
                    },
                    "Subject": {
                        "EditForm": readonlyFieldTemplate,
                    },
                    "FileUrl": {
                        "EditForm": readonlyFieldTemplate,
                    }

                };
            }
        }
        SPClientTemplates.TemplateManager.RegisterTemplateOverrides(percentCompleteFiledContext);
    })();
    function readonlyFieldTemplate(ctx) {
        //Reuse ready sharepoint javascript libraries
        switch (ctx.CurrentFieldSchema.FieldType) {
            case "Text":
            case "Number":
            case "Integer":
            case "Currency":
            case "Choice":
            case "Computed":
                return SPField_FormDisplay_Default(ctx);
            case "MultiChoice":
                prepareMultiChoiceFieldValue(ctx);
                return SPField_FormDisplay_Default(ctx);
            case "Boolean":
                return SPField_FormDisplay_DefaultNoEncode(ctx);
            case "Note":
                prepareNoteFieldValue(ctx);
                return SPFieldNote_Display(ctx);
            case "File":
                return SPFieldFile_Display(ctx);
            case "Lookup":
            case "LookupMulti":
                return SPFieldLookup_Display(ctx);
            case "URL":
                return RenderFieldValueDefault(ctx);
            case "User":
                prepareUserFieldValue(ctx);
                return SPFieldUser_Display(ctx);
            case "UserMulti":
                prepareUserFieldValue(ctx);
                return SPFieldUserMulti_Display(ctx);
            case "DateTime":
                dateNoteFieldValue(ctx);
                return SPFieldDateTime_Display(ctx);
            case "Attachments":
                return SPFieldAttachments_Default(ctx);
            case "TaxonomyFieldType":
                //Re-use ready sharepoint inside sp.ui.taxonomy.js javascript libraries
                return SP.UI.Taxonomy.TaxonomyFieldTemplate.renderDisplayControl(ctx);
        }
    }
    function hiddenFiledTemplate() {
        return "<span class='csrHiddenField'></span>";
    }

    // This function provides the rendering logic
    function hiddenFiledOnPreRender(ctx) {
        $(".csrHiddenField").closest("tr").hide();
    }
    //Note control need specific formatted value to render content correctly
    function dateNoteFieldValue(ctx) {

        var item = ctx["CurrentFieldValue"];
        var fieldValue = new Date(item).format("yyyy/MM/dd");

        ctx["CurrentFieldValue"] = fieldValue;
    }
    //User control need specific formatted value to render content correctly
    function prepareUserFieldValue(ctx) {
        var item = ctx['CurrentItem'];
        var userField = item[ctx.CurrentFieldSchema.Name];
        var fieldValue = "";

        for (var i = 0; i < userField.length; i++) {
            fieldValue += userField[i].EntityData.SPUserID + SPClientTemplates.Utility.UserLookupDelimitString + userField[i].DisplayText;

            if ((i + 1) != userField.length) {
                fieldValue += SPClientTemplates.Utility.UserLookupDelimitString
            }
        }

        ctx["CurrentFieldValue"] = fieldValue;
    }

    //Choice control need specific formatted value to render content correctly
    function prepareMultiChoiceFieldValue(ctx) {

        if (ctx["CurrentFieldValue"]) {
            var fieldValue = ctx["CurrentFieldValue"];

            var find = ';#';
            var regExpObj = new RegExp(find, 'g');

            fieldValue = fieldValue.replace(regExpObj, '; ');
            fieldValue = fieldValue.replace(/^; /g, '');
            fieldValue = fieldValue.replace(/; $/g, '');

            ctx["CurrentFieldValue"] = fieldValue;
        }
    }

    //Note control need specific formatted value to render content correctly
    function prepareNoteFieldValue(ctx) {

        if (ctx["CurrentFieldValue"]) {
            var fieldValue = ctx["CurrentFieldValue"];
            fieldValue = "<div>" + fieldValue.replace(/\n/g, ''); + "</div>";

            ctx["CurrentFieldValue"] = fieldValue;
        }
    }
</script>
